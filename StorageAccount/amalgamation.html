<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<style>
    .table-responsive {
    	display:table-cell;
    	width:100%;
		}
	.alert-success-alt {border-color: #19B99A; background: #137792}
</style>
<script src="scripts/azure-storage.blob.min.js" charset="utf-8"></script>
<script type='text/javascript'>
	const account = {
		name: '__AMLGStorageAccountName__',
		sas:  '__AMLGStorageAccountName_SASToken__',
		container: '__AMLGDownloadContainerName__',
		filter: '__AMLGFileListFilter__',
		topXrecords: __AMLGTopXrecords__
	};
	
	function fileSize(size) {
	   var i = Math.floor(Math.log(size) / Math.log(1024));
	    return (size / Math.pow(1024, i)).toFixed(2) * 1 + ' '+['B', 'kB', 'MB', 'GB', 'TB'][i];
	}

	function sortFunction(a,b){  
		var dateA = new Date(a.date).getTime();
		var dateB = new Date(b.date).getTime();
		return dateA > dateB ? 1 : -1;  
	}; 

	function listContent()
	{
		document.getElementById('Release').innerHTML = 'Loading...';

		const blobUri = 'https://' + account.name + '.blob.core.windows.net';
		const blobService = AzureStorage.Blob.createBlobServiceWithSas(blobUri, account.sas);
		
		blobService.listBlobsSegmented(account.container, null, (error, results) => {
        if (error) {
				document.getElementById('Release').innerHTML = 'Error Getting Data.' + '<br>' + error;
				return;
			} else {
				var output = [];

				output.push('<tr>',
							'<th>Link</th>',
							'<th>Size</th>',
							'<th>LastModified</th>',
							'</tr>');
				if (results.entries.length < 1) {
					output.push('<tr><td>Empty results...</td></tr>');
				}
				else
				{
					results.entries.sort(function(a,b){
					  // Turn your strings into dates, and then subtract them
					  // to get a value that is either negative, positive, or zero.
					  return new Date(b.lastModified) - new Date(a.lastModified);
					});

					let sortToList = results.entries.slice(0, account.topXrecords);

					for (var i = 0, blob; blob = sortToList[i]; i++) {
						if (blob.name.toLowerCase().startsWith(account.filter.toLowerCase()))
						{
							output.push('<tr>',
										'<td><a href='+blobUri+"/"+account.container+"/"+blob.name+'>', blob.name, '</a></td>',
										'<td>', fileSize(blob.contentLength), ' </td>',
										'<td>', blob.lastModified, '</td>',
										'</tr>');
						}
					}
				}
				document.getElementById('Release').innerHTML = '<table class="table table-condensed table-bordered">' + output.join('') + '</table>';
			}
		});
	}	

</script>
</head>
<body onload="listContent()">
    <div class="container">
<div id="header" class="alert alert-success-alt" role="alert">
    <h3 class="Display-3">Amalgamation Download</h3>
    </br>
<div ><h5>Please select the appropriate release from the following list and download:</h5></div>
</div>
<div id="Release" class="table-responsive">Loading</div>
<div >
</br>
    <h4 >Previous Releases:</h4>
</br>
</div>
<footer>
    <p>Build : __AMLGBuildNumber__</p>
    <p>Branch : __AMLGBranch__</p>
    <p>Last Deplopyment : __AMLGReleaseDate__</p>
</footer>
</body>
</html>
